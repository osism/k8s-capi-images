---
compute_engine_instance:
  image_project: cirrus-images
  image: family/docker-kvm
  platform: linux
  cpu: 4
  memory: 16G
  disk: 100
  nested_virtualization: true

# environment variables

env:
  DEBIAN_FRONTEND: noninteractive
  HOME: "$CIRRUS_WORKING_DIR"
  PACKER_TMP_DIR: "$CIRRUS_WORKING_DIR/.packer.d"
  MINIO_ACCESS_KEY: "ENCRYPTED[77f033c741c72cde32b377c0bef41897e741b4bbf1a6a4d1e9ce51ab5c7b1a49086d9e88fa072c4e82dac483ca484667]"
  MINIO_SECRET_KEY: "ENCRYPTED[f4ebc46ccbdf36946f38c6c881ef69ee689af6a62318116857d46e2c37cedc8a8845e9d6f15390a37774d8f240f0a5f5]"

build_task_template: &BUILD_TASK_TEMPLATE
  timeout_in: 120m
  install_script: |
    while fuser /var/lib/dpkg/lock >/dev/null 2>&1; do sleep 5; done;
    while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 5; done;
    apt-get update
    while fuser /var/lib/dpkg/lock >/dev/null 2>&1; do sleep 5; done;
    while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 5; done;
    apt-get install -y git make python3-pip curl jq unzip

  prepare_script: |
    git clone https://github.com/kubernetes-sigs/image-builder
    cd image-builder/images/capi
    export PATH=$PWD/.bin:$HOME/.local/bin:$PATH
    make deps-qemu

  build_script: |
    cd image-builder/images/capi
    export PATH=$PWD/.bin:$HOME/.local/bin:$PATH
    make build-qemu-ubuntu-$DISTRO_VERSION

  prepare_push_script: |
    pushd image-builder/images/capi/output/ubuntu-$DISTRO_VERSION-kube-v$IMAGE_IDENTIFIER
    find . -type f -execdir bash -c 'x={}; cp $x ${x%.*}.qcow2; mv $x $x.qcow2' \;
    find . -name '*.qcow2' -execdir bash -c 'x={}; sha256sum $(basename $x) > $x.CHECKSUM' \;
    VARS_FILE_SUFFIX=${IMAGE_IDENTIFIER//.}
    VARS_FILE_SUFFIX=${VARS_FILE_SUFFIX//-/_}
    KUBERNETES_SEMVER=$(jq -r '.kubernetes_semver' $CIRRUS_WORKING_DIR/extra_vars_${VARS_FILE_SUFFIX}.json)
    echo "$(date +%Y-%m-%d) ubuntu-$DISTRO_VERSION-kube-v$IMAGE_IDENTIFIER/ubuntu-$DISTRO_VERSION-kube-$KUBERNETES_SEMVER.qcow2" > "last-$IMAGE_IDENTIFIER"
    ls -lah
    popd
    mv image-builder/images/capi/output/ubuntu-$DISTRO_VERSION-kube-v$IMAGE_IDENTIFIER/last-$IMAGE_IDENTIFIER .
    cat last-$IMAGE_IDENTIFIER

  push_script: |
    if [[ "$CIRRUS_BRANCH" == "main" ]]; then
      wget https://dl.min.io/client/mc/release/linux-amd64/mc
      chmod +x mc
      ./mc alias set minio https://nbg1.your-objectstorage.com $MINIO_ACCESS_KEY $MINIO_SECRET_KEY
      ./mc cp last-$IMAGE_IDENTIFIER minio/osism/openstack-k8s-capi-images/
      ./mc cp --recursive image-builder/images/capi/output/* minio/osism/openstack-k8s-capi-images/
      ./mc policy set download minio/osism/openstack-k8s-capi-images/
    fi

build_132_task:
  <<: *BUILD_TASK_TEMPLATE
  skip: "!changesInclude('extra_vars_132.json', '.cirrus.yml')"
  env:
    IMAGE_IDENTIFIER: "1.32"
    DISTRO_VERSION: "2204"
    PACKER_VAR_FILES: ../../../extra_vars_132.json

build_133_task:
  <<: *BUILD_TASK_TEMPLATE
  skip: "!changesInclude('extra_vars_133.json', '.cirrus.yml')"
  env:
    IMAGE_IDENTIFIER: "1.33"
    DISTRO_VERSION: "2404"
    PACKER_VAR_FILES: ../../../extra_vars_133.json

build_133_gardener_task:
  <<: *BUILD_TASK_TEMPLATE
  skip: "!changesInclude('extra_vars_133_gardener.json', '.cirrus.yml')"
  env:
    IMAGE_IDENTIFIER: "1.33-gardener"
    DISTRO_VERSION: "2404"
    PACKER_VAR_FILES: ../../../extra_vars_133_gardener.json

build_134_task:
  <<: *BUILD_TASK_TEMPLATE
  skip: "!changesInclude('extra_vars_134.json', '.cirrus.yml')"
  env:
    IMAGE_IDENTIFIER: "1.34"
    DISTRO_VERSION: "2404"
    PACKER_VAR_FILES: ../../../extra_vars_134.json

build_135_task:
  <<: *BUILD_TASK_TEMPLATE
  skip: "!changesInclude('extra_vars_135.json', '.cirrus.yml')"
  env:
    IMAGE_IDENTIFIER: "1.35"
    DISTRO_VERSION: "2404"
    PACKER_VAR_FILES: ../../../extra_vars_135.json
